## ğŸ¥ ì‹¤ì‹œê°„ ë°©ì†¡(WebRTC)ì„ í™œìš©í•œ ì˜¨ë¼ì¸ ê²½ë§¤ í”Œë«í¼
**BIDCAST**ëŠ” ëˆ„êµ¬ë‚˜ ê²½ë§¤ë¥¼ ê°œì„¤í•˜ê³  ì…ì°°ì— ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ì‹¤ì‹œê°„ ì˜ìƒ ê¸°ë°˜ ê²½ë§¤ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.  
ì‹¤ì‹œê°„ ì±„íŒ…, ì˜ìƒ ê³µìœ , ì…ì°° ê¸°ëŠ¥ì„ í†µí•´ ìƒë™ê° ìˆëŠ” ê²½ë§¤ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.

ğŸ”— [BIDCAST ì„œë²„ GitHub](https://github.com/KR-HS/BidCast_Server)
ğŸ”— [BIDCAST í´ë¼ì´ì–¸íŠ¸ GitHub](https://github.com/KR-HS/BidCast) 
ğŸ”— [AWSì„¸íŒ…í•˜ê¸°](AWSì„¸íŒ….md) 
ğŸŒ [BIDCAST í™ˆí˜ì´ì§€](https://bidcast.kro.kr)

---

### ğŸ”§ ì£¼ìš” ê¸°ëŠ¥
- **ê²½ë§¤ íƒìƒ‰**: ê²½ë§¤ ì¼ì •ê³¼ ê²€ìƒ‰ ê¸°ëŠ¥ì„ í†µí•´ ì›í•˜ëŠ” ê²½ë§¤ë¥¼ ì†ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê´€ì‹¬ ê²½ë§¤ ë“±ë¡**: ë§ˆì´í˜ì´ì§€ì—ì„œ ê´€ì‹¬ ê²½ë§¤ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê²½ë§¤ ê°œì„¤**: ëˆ„êµ¬ë‚˜ ê²½ë§¤ì‚¬ê°€ ë˜ì–´ ê²½ë§¤ë¥¼ ê°œì„¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê²½ë§¤ ì§„í–‰ ê¸°ëŠ¥**:
  - ê²½ë§¤ì‚¬ëŠ” ì‹¤ì‹œê°„ ë°©ì†¡ì„ í†µí•´ ì…ì°°ì„ ì§„í–‰í•˜ê³ , ë¬¼í’ˆì„ ë‚™ì°°/ìœ ì°° ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ê²½ë§¤ ë‹¨ìœ„ ì¡°ì • ë° ì…ì°° ì¢…ë£Œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
- **ì…ì°°ì ê¸°ëŠ¥**:
  - ì‹¤ì‹œê°„ ì…ì°°, ë‚™ì°°/ìœ ì°° ê²°ê³¼ë¥¼ ëª¨ë‹¬ ë° ì˜ìƒì„ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
  - ì‹¤ì‹œê°„ ì±„íŒ…ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. (ìµœê·¼ 40ê°œ ë©”ì‹œì§€ ìœ ì§€)
- **ë§ˆì´í˜ì´ì§€**:
  - ê²½ë§¤ ì´ë ¥, ë‚™ì°° ë‚´ì—­, ë“±ë¡ ìƒí’ˆ ìƒíƒœ ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
### ğŸ“¦ í”„ë¡œì íŠ¸ êµ¬ì„± ë° ë°°í¬
- **Vite ê¸°ë°˜ ë©€í‹° í˜ì´ì§€ êµ¬ì„±**
- **EC2 ë°°í¬**, **Nginx + certbotìœ¼ë¡œ HTTPS** ì„¤ì •
- **Jenkins**ë¥¼ í†µí•œ **CI/CD êµ¬ì¶•**
- **AWS S3**ë¥¼ í†µí•œ íŒŒì¼ ì €ì¥
- **PostgreSQL (RDS)** ê¸°ë°˜ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©
- **JWT**ë¥¼ í†µí•œ ì¸ì¦ ë° **ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”** ì ìš©
> âš ï¸ **ì£¼ì˜**: `application-custom.properties` íŒŒì¼ì€ Gitì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
> *ì§ì ‘ `src/main/resources` ê²½ë¡œì— ì•„ë˜ ë‚´ìš©ì„ í¬í•¨í•œ íŒŒì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”:*

<details>
<summary><code>application-custom.properties</code> ì˜ˆì‹œ ë³´ê¸°</summary>

```bash
properties
spring.datasource.url=jdbc:postgresql://<DBì£¼ì†Œ>:5432/bidcast
spring.datasource.username=<DBìœ ì €>
spring.datasource.password=<DBë¹„ë°€ë²ˆí˜¸>

jwt.secret=<JWT ë¹„ë°€ í‚¤>
jwt.expiration=3600000

aws.s3.access-key=<AccessKey>
aws.s3.secret-key=<SecretKey>
aws.s3.region=ap-northeast-2
aws.s3.bucket=<ë²„í‚·ëª…>
aws.s3.folder=uploads
```
</details> 

---

### ğŸ›  ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ

> ### 1. Server
> #### 1-1. App Server (ìœ ì € ì„œë¹„ìŠ¤)
> - **Build Tools**: `Vite`, `Gradle`
> - **Front-End**: `React`, `HTML`, `CSS`, `Thymeleaf`
> - **Back-End**: `Spring Boot`, `WebRTC`, `WebSocket`
> - **Persistence**: `MyBatis`
> - **Authorization**: `JWT`, `Spring Security`
>
> #### 1-2. SFU Server (ì¤‘ê³„ ì„œë²„)
> - `Node.js`, `WebRTC`, `mediasoup`, `WebSocket`
>
> #### 1-3. Database
> - `Amazon RDS`, `PostgreSQL`
>
> #### 1-4. Cloud Storage
> - `Amazon S3`

> ### 2. Infrastructure
> - `Nginx`, `certbot`, `Let's Encrypt`

> ### 3. Dev Tools
> - `IntelliJ IDEA`, `Figma`

> ### 4. Collaboration
> - `Git`, `GitHub`

> ### 5. CI/CD
> - `Jenkins`


---

# ì„œë²„ ì½”ë“œë¶„ì„

# 1.WebSocket
<details>
<summary>ì ‘ê¸°/í¼ì¹˜ê¸°</summary>

### ì¢…ë¥˜

- **`socket`**  
  **í´ë¼ì´ì–¸íŠ¸ í•˜ë‚˜í•˜ë‚˜ì˜ ì—°ê²°**ì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´
  í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ì™€ **1:1 í†µì‹ **í•˜ê±°ë‚˜ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©

- **`io`**  
  **ì „ì²´ ì†Œì¼“ ì„œë²„ ê°ì²´**ë¡œ, **ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê±°ë‚˜ íŠ¹ì • ë°©(room)ì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬**í•  ë•Œ ì‚¬ìš©
  ì˜ˆ: `io.to(roomId).emit('event',data)`

- **`broadcast`**  
  **ìì‹ ì„ ì œì™¸í•œ ê°™ì€ ë°© ë˜ëŠ” ì „ì²´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡**
  ì˜ˆ: `socket.broadcast.emit()` â€” ìê¸° ìì‹ ì„ ì œì™¸í•œ ëª¨ë‘ì—ê²Œ ì „ì†¡

### ë°©ì‹

- **`on`**  
  í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° **ì´ë²¤íŠ¸ê°€ ì™”ì„ ë•Œ** ì‹¤í–‰í•  ì½œë°±ì„ ë“±ë¡  
  ì˜ˆ: `socket.on('produce', callback)`

- **`emit`**  
  **ì´ë²¤íŠ¸ì™€ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” ë°©ì‹**  
  ì„œë²„ â†” í´ë¼ì´ì–¸íŠ¸ ì–‘ë°©í–¥ìœ¼ë¡œ ì‚¬ìš©
  ì˜ˆ: `socket.emit('new-producer', data)`

---

## WebRTC & mediasoup

### WebRTC

- **ì‹¤ì‹œê°„ ìŒì„±, ì˜ìƒ, ë°ì´í„° í†µì‹ ì„ ìœ„í•œ í‘œì¤€ ê¸°ìˆ **
- ë¸Œë¼ìš°ì € ë˜ëŠ” ë„¤ì´í‹°ë¸Œ ì•± ê°„ **P2P ì—°ê²°ì„ ì§€ì›**
- ì§ì ‘ ì—°ê²°ì´ ì–´ë ¤ìš´ ê²½ìš° **SFU ë°©ì‹** ì‚¬ìš© (Selective Forwarding Unit)

#### ICE, STUN, TURN

| ìš©ì–´   | ì„¤ëª… |
|--------|------|
| **ICE**  | ì—°ê²° ê°€ëŠ¥í•œ í›„ë³´ ì£¼ì†Œë“¤ì„ ìˆ˜ì§‘í•´ ìµœì  ê²½ë¡œë¥¼ ì„ íƒí•˜ëŠ” í”„ë ˆì„ì›Œí¬ |
| **STUN** | ê³µì¸ IP ë° í¬íŠ¸ ì •ë³´ë¥¼ ì•Œì•„ë‚´ê¸° ìœ„í•œ ì„œë²„ |
| **TURN** | P2P ì—°ê²°ì´ ë¶ˆê°€í•œ ê²½ìš° ë¯¸ë””ì–´ë¥¼ **ì¤‘ê³„**í•´ì£¼ëŠ” ì„œë²„ (ëŒ€ì—­í­ ì†Œëª¨ â†‘) |

### mediasoup

- **WebRTC SFU ì„œë²„ êµ¬í˜„ ë¼ì´ë¸ŒëŸ¬ë¦¬** 
- ë¯¸ë””ì–´ íë¦„ ì œì–´ë¥¼ ìœ„í•œ ê°ì²´ ê¸°ë°˜ êµ¬ì¡°

### mediasoup ì£¼ìš” ê°œë…

| ìš©ì–´       | ì„¤ëª… |
|------------|-----|
| **Worker**     | ë¯¸ë””ì–´ ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” **ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤** |
| **Router**     | í•œ ë°©(room)ì— í•˜ë‚˜ì”© ì¡´ì¬, **ë¯¸ë””ì–´ ê²½ë¡œ ì œì–´** ì—­í•  |
| **Transport**  | **í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ë¯¸ë””ì–´ ì—°ê²° í†µë¡œ** (DTLS/ICE ë“± í¬í•¨) |
| **Producer**   | í´ë¼ì´ì–¸íŠ¸ê°€ **ë¯¸ë””ì–´ë¥¼ ì†¡ì¶œí•  ë•Œ** ìƒì„±ë˜ëŠ” ê°ì²´ |
| **Consumer**   | í´ë¼ì´ì–¸íŠ¸ê°€ **ë¯¸ë””ì–´ë¥¼ ìˆ˜ì‹ í•  ë•Œ** ìƒì„±ë˜ëŠ” ê°ì²´ |

<details>
<summary>ìƒì„¸ ì„¤ëª…</summary>

- **Worker** : ë¯¸ë””ì–´ ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” **ì—”ì§„** ê°™ì€ í”„ë¡œì„¸ìŠ¤, ì‹¤ì œ ë¯¸ë””ì–´ ë°ì´í„°(ìŒì„±, ì˜ìƒ)ë¥¼ ë‹¤ë£¸ 
- **Router** : producerê°€ ë³´ë‚´ëŠ” ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ ë°›ì•„ì„œ ì–´ë–¤ consumerì—ê²Œ ë³´ë‚¼ì§€ ì •í•¨. í•˜ë‚˜ì˜ ë°©ì—ëŠ” í•˜ë‚˜ì˜ Routerê°€ ìˆìŒ
- **Transport** : ICE ì—°ê²°, DTLS í•¸ë“œì…°ì´í¬ ë“±ì„ í¬í•¨í•œ í†µì‹  ê²½ë¡œ, consumer/producer ê°ê° ì“°ëŠ” tranportê°€ ë‹¤ë¦„
</details>


## rtpCapabilities

- **WebRTC ì—°ê²° ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¯¸ë””ì–´ í˜•ì‹ (ì½”ë±, í•´ìƒë„ ë“±) ëª©ë¡**
- ì†¡ì‹ ìì™€ ìˆ˜ì‹ ìì˜ **ë¯¸ë””ì–´ í˜¸í™˜ ì—¬ë¶€ë¥¼ íŒë‹¨**í•˜ê¸° ìœ„í•´ í•„ìˆ˜
- ì˜ˆì‹œ:
  ```
  {
    "codecs": [
      { "kind": "audio", "mimeType": "audio/opus", ... },
      { "kind": "video", "mimeType": "video/VP8", ... }
    ]
  }
  ```

## DTLS
- **UDP ê¸°ë°˜** í†µì‹ ì—ì„œ **ë³´ì•ˆ ì—°ê²°ì„ ìœ„í•œ SSL/TLS ê³„ì¸µ**
- WebRTCì—ì„œ **ë¯¸ë””ì–´ ë°ì´í„° ì•”í˜¸í™” ë° ì¸ì¦** ì—­í•  ìˆ˜í–‰

---

## ì„œë²„ ë¯¸ë””ì–´ ì²˜ë¦¬ íë¦„
<details>
<summary>ì ‘ê¸°/í¼ì¹˜ê¸°</summary>

### 1) rtpCapabilities ìš”ì²­

```
socket.on('create-router', (_, callback) => {
  callback({ rtpCapabilities: router.rtpCapabilities });
});
```

### 2) Transport ìƒì„±
<details>
<summary>create-transport ì½”ë“œ ë³´ê¸°</summary>

```bash
socket.on('create-transport', async ({ direction }, callback) => {
  const transport = await router.createWebRtcTransport({
    listenIps: [{ ip: '0.0.0.0', announcedIp: 'bidcastserver.kro.kr' }],
    enableUdp: true,
    enableTcp: true,
    preferUdp: true,
    portRange: { min: 40000, max: 40010 },
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'turn:bidcastserver.kro.kr:3478', username: 'webrtc', credential: '1234' }
    ],
  });
  transports.set(transport.id, { transport, socketId: socket.id, direction });

  callback({
    id: transport.id,
    iceParameters: transport.iceParameters,
    iceCandidates: transport.iceCandidates,
    dtlsParameters: transport.dtlsParameters,
  });
});
```
</details>

### 3) Transport ì—°ê²° (DTLS í•¸ë“œì‰ì´í¬)
```
socket.on('connect-transport', async ({ dtlsParameters, transportId }, callback) => {
  const data = transports.get(transportId);
  if (!data) throw new Error('Transport not found');
  await data.transport.connect({ dtlsParameters });
  callback();
});
```

### 4) Producer ìƒì„± (ë¯¸ë””ì–´ ì†¡ì¶œ ì‹œì‘)
<details> 
<summary>produce ìš”ì²­ ì²˜ë¦¬</summary>

```
socket.on('produce', async ({ kind, rtpParameters, transportId, roomId }, callback) => {
  const data = transports.get(transportId);
  if (!data) throw new Error('Transport not found');
  const producer = await data.transport.produce({ kind, rtpParameters });

  if (!producers.has(roomId)) producers.set(roomId, new Map());
  producers.get(roomId).set(producer.id, { producer, socketId: socket.id, kind });

  socket.broadcast.to(roomId).emit('new-producer', {
    producerId: producer.id,
    socketId: socket.id,
    kind,
  });

  callback({ id: producer.id });
});
```
</details>

### 5) Consumer ìƒì„± (ë¯¸ë””ì–´ ìˆ˜ì‹  ìš”ì²­)
<details> <summary>consume ìš”ì²­ ì²˜ë¦¬</summary>

```
socket.on('consume', async ({ producerId, rtpCapabilities, transportId, roomId }, callback) => {
  const data = transports.get(transportId);
  if (!data) throw new Error('Transport not found');

  const roomProducers = producers.get(roomId);
  if (!roomProducers || !roomProducers.has(producerId)) throw new Error('Producer not found');

  if (!router.canConsume({ producerId, rtpCapabilities })) throw new Error('Cannot consume');

  const consumer = await data.transport.consume({
    producerId,
    rtpCapabilities,
    paused: false,
  });

  consumers.set(consumer.id, { consumer, socketId: socket.id });

  callback({
    id: consumer.id,
    producerId,
    kind: consumer.kind,
    rtpParameters: consumer.rtpParameters,
  });
});
```
</details>

### 6) Consumer ì¬ìƒ ì‹œì‘
```
socket.on('consumer-resume', async ({ consumerId }) => {
  const data = consumers.get(consumerId);
  if (!data) return;
  await data.consumer.resume();
});
```

### 7) ì—°ê²° ì¢…ë£Œ ì‹œ ìì› ì •ë¦¬
<details> <summary>disconnect ì²˜ë¦¬ ì „ì²´ ì½”ë“œ</summary>

```bash
socket.on('disconnect', () => {
  for (const [transportId, data] of transports) {
    if (data.socketId === socket.id) {
      data.transport.close();
      transports.delete(transportId);
    }
  }
  for (const [roomId, roomProducers] of producers) {
    for (const [producerId, data] of roomProducers) {
      if (data.socketId === socket.id) {
        data.producer.close();
        roomProducers.delete(producerId);
        io.emit('user-disconnected', {
          socketId: socket.id,
          producerId,
        });
      }
    }
    if (roomProducers.size === 0) producers.delete(roomId);
  }
  for (const [consumerId, data] of consumers) {
    if (data.socketId === socket.id) {
      data.consumer.close();
      consumers.delete(consumerId);
    }
  }
});
```
</details>

</details>

</details>

---

# 2. ì„œë²„ ì£¼ìš” ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ ì •ë¦¬

<details>
<summary>ì ‘ê¸°/í¼ì¹˜ê¸°</summary>

---

## 1. mediasoup ê´€ë ¨ ë³€ìˆ˜

- `transports` (Map)  
  transportIdë¥¼ keyë¡œ, `{ transport, socketId, direction }` ê°ì²´ë¥¼ valueë¡œ ì €ì¥  
  - mediasoup WebRTC ì—°ê²°ìš© Transport ê°ì²´ ê´€ë¦¬ìš©

- `producers` (Map)  
  roomIdë¥¼ keyë¡œ, valueëŠ” ë˜ ë‹¤ë¥¸ Map  
  ë‚´ë¶€ Map: producerIdë¥¼ keyë¡œ `{ producer, socketId, kind }`  
  - ê° ë°©(room)ë³„ ë¯¸ë””ì–´ ì†¡ì¶œì(Producer) ê°ì²´ ì €ì¥

- `consumers` (Map)  
  consumerIdë¥¼ keyë¡œ, `{ consumer, socketId }` ì €ì¥  
  - ë¯¸ë””ì–´ ìˆ˜ì‹ ì(Consumer) ê°ì²´ ê´€ë¦¬


## 2. ì†Œì¼“ & ë°© ê´€ë¦¬ ë³€ìˆ˜

- `socketRoomMap` (Map)  
  socketIdë¥¼ keyë¡œ, í˜„ì¬ ì‚¬ìš©ìê°€ ì…ì¥í•œ roomId ì €ì¥  
  - í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë°©ì— ë™ì‹œì— ì ‘ì†í•˜ì§€ ëª»í•˜ë„ë¡ ì œí•œí•˜ëŠ” ì—­í• 

- `socketIdMap` (Map)  
  loginIdë¥¼ keyë¡œ, ì†Œì¼“ ID ì €ì¥  
  - ë¡œê·¸ì¸ ìœ ì €ì™€ ì†Œì¼“ ì—°ê²° ê´€ë¦¬

- `auctionHostMap` (Map)  
  auctionIdë¥¼ keyë¡œ, í•´ë‹¹ ê²½ë§¤ì˜ í˜¸ìŠ¤íŠ¸ ì†Œì¼“ ID ì €ì¥  
  - ê²½ë§¤ë³„ í˜¸ìŠ¤íŠ¸ ì†Œì¼“ ê´€ë¦¬

- `auctionStates` (ê°ì²´)  
  auctionIdë¥¼ keyë¡œ, ê²½ë§¤ ì§„í–‰ ìƒíƒœ(ì„ íƒëœ ìƒí’ˆ ë“±) ì €ì¥  
  - ê²½ë§¤ ìƒíƒœ ë° ì§„í–‰ ì •ë³´ ê´€ë¦¬

- `auctionUserStatus` (ê°ì²´)  
  socketIdë¥¼ keyë¡œ, ì…ì°°ì ë‹‰ë„¤ì„, ë§ˆì§€ë§‰ ì…ì°°ê°€ ë“± ìƒíƒœ ì €ì¥  
  - ì…ì°°ì ê°œì¸ë³„ í˜„ì¬ ìƒíƒœ ì •ë³´ë¥¼ ì €ì¥


## 3. ìƒí’ˆ ë°ì´í„° ì •ê·œí™” í•¨ìˆ˜

```
function normalizeProduct(raw) {
  return {
    prodKey: raw.prod_key,
    aucKey: raw.auc_key,
    prodName: raw.prod_name,
    prodDetail: raw.prod_detail,
    unitValue: raw.unit_value,
    initPrice: raw.init_price,
    currentPrice: raw.current_price,
    finalPrice: raw.final_price,
    winnerId: raw.winner_id,
    prodStatus: raw.prod_status,
    fileUrl: raw.file_url
  };
}
```
</details>

---
# 3. í´ë¼ì´ì–¸íŠ¸-ì„œë²„ í†µì‹  íë¦„

<details>
<summary>ì ‘ê¸°/í¼ì¹˜ê¸°</summary>

## 1. ê²½ë§¤ì¥ ì…ì¥/í‡´ì¥

### ì…ì¥
- ìš”ì²­: `join-room(roomId, userInfo)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `socketRoomMap[socket.id] = roomId`
  - `socketIdMap[userInfo.loginId] = socket.id`
  - `auctionUserStatus[socket.id] = { nickname, lastBid: 0 }`
- ì‘ë‹µ:
  - ì…ì¥ì ëª©ë¡ ë°˜í™˜
  - ê¸°ì¡´ ìœ ì €ì—ê²Œ `user-status-update` ë¸Œë¡œë“œìºìŠ¤íŠ¸

### í‡´ì¥
- ë°œìƒ: ì†Œì¼“ ì¢…ë£Œ ì‹œ ìë™
- ì²˜ë¦¬:
  - `transports`, `producers`, `consumers`ì—ì„œ socket ìì› ì œê±°
  - `socketRoomMap`, `socketIdMap`, `auctionUserStatus`ì—ì„œ ì œê±°
- ë¸Œë¡œë“œìºìŠ¤íŠ¸: `user-disconnected`


## 2. ì˜ìƒ ì†¡ì¶œ (mediasoup)

### ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ë°œì†¡
- ìš”ì²­: `produce(kind, rtpParameters, transportId, roomId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `transports[transportId]` í™•ì¸
  - `producers[roomId][producerId] = { producer, socketId, kind }`
- ì‘ë‹µ: `producerId`
- ë¸Œë¡œë“œìºìŠ¤íŠ¸: `new-producer`

### ê¸°ì¡´ Producer ë¦¬ìŠ¤íŠ¸ ìš”ì²­
- ìš”ì²­: `get-existing-producers(roomId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `producers` Map(roomId â†’ Map(producerId â†’ { producer, socketId, kind }))  
  - `auctionHostMap` (roomId â†’ hostSocketId)
- ì‘ë‹µ: ì½œë°±ìœ¼ë¡œ `{ existingProducers, hostSocketId }` ë°˜í™˜

### Producer ì‚­ì œ
- ìš”ì²­: `close-producer(roomId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `producers` Mapì—ì„œ socket.idì— í•´ë‹¹í•˜ëŠ” Producer ê°ì²´ ì œê±° ë° close í˜¸ì¶œ
- ë¸Œë¡œë“œìºìŠ¤íŠ¸:
  - í•´ë‹¹ ê²½ë§¤ë°©ì— `user-disconnected` ì´ë²¤íŠ¸ (í•´ë‹¹ socketId, producerId) ì „ì†¡
- ì¶”ê°€:
  - ë°© ë‚´ Producerê°€ ì—†ìœ¼ë©´ `producers` Mapì—ì„œ í•´ë‹¹ roomId ì‚­ì œ

### ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ìš”ì²­
- ìš”ì²­: `consume(producerId, rtpCapabilities, transportId, roomId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `transports[transportId]` í™•ì¸
  - `consumers[consumerId] = { consumer, socketId }`
- ì‘ë‹µ: `{ consumerId, producerId, kind, rtpParameters }`

### ì¬ìƒì‹œì‘
- ìš”ì²­: `consumer-resume(consumerId)`
- ì²˜ë¦¬: `consumers[consumerId].consumer.resume()`


## 3. ì±„íŒ…

### ì±„íŒ…
- ìš”ì²­: `chat-message(roomId, userId, message)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `socketRoomMap[socket.id]` â†’ roomId ì¶”ì¶œ
- ë¸Œë¡œë“œìºìŠ¤íŠ¸: `chat-message`


## 4. ì…ì°°

### ì…ì°°ì‹œë„
- ìš”ì²­: `bid-attempt(roomId, productId, bidAmount,userLoginId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `auctionStates[auctionId]` â†’ ì„ íƒëœ ìƒí’ˆ ìƒíƒœ ê°±ì‹   
  - `auctionUserStatus[auctionId][socket.id]` â†’ ì…ì°°ìë³„ ì…ì°° ê¸°ë¡ ì €ì¥  
  - `pool.query()` â†’ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ, ìƒí’ˆ ê°€ê²© ê°±ì‹ , ì…ì°° ê¸°ë¡ ì €ì¥
- ë¸Œë¡œë“œìºìŠ¤íŠ¸:
  - `user-status-update` â†’ ì…ì°°ì ìƒíƒœ ê°±ì‹  ì „ì²´ ì „ì†¡  
  - `bid-update` â†’ ì…ì°° ê²°ê³¼(ìƒí’ˆ, ì…ì°°ì ì •ë³´ í¬í•¨) ì „ì†¡  
  - `bid-rejected` â†’ ì…ì°° ì‹¤íŒ¨ ì‹œ ê°œë³„ ì‘ë‹µ


## 5. ê²½ë§¤ ê´€ë¦¬ (í˜¸ìŠ¤íŠ¸)

### ìƒí’ˆ ì„ íƒ
- ìš”ì²­: `host-selected-product(auctionId, product)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `auctionStates[auctionId].selectedProduct = product`
  - DB `product.prod_status = 'P'` ì—…ë°ì´íŠ¸
- ë¸Œë¡œë“œìºìŠ¤íŠ¸:
  - í•´ë‹¹ ê²½ë§¤ë°©ì— `host-selected-product` (ì„ íƒëœ ìƒí’ˆ ì •ë³´) ì „ì†¡

### ë‚™ì°° / ìœ ì°° ìƒíƒœ ë³€ê²½
- ìš”ì²­: `bid-status(auctionId, prodKey, winner_id, status)`
- ì‚¬ìš© ë³€ìˆ˜:
  - DB `product.prod_status` ì—…ë°ì´íŠ¸ (`'C'` or `'F'`)
  - `auctionUserStatus[auctionId]`ì—ì„œ í•´ë‹¹ ìƒí’ˆ ì…ì°° ê¸°ë¡ ì‚­ì œ
- ë¸Œë¡œë“œìºìŠ¤íŠ¸:
  - í•´ë‹¹ ë°©ì— `bid-status` (ìƒí’ˆ ìƒíƒœ, ë‚™ì°°ì ì •ë³´) ì „ì†¡ (í˜¸ìŠ¤íŠ¸ ì œì™¸)
  - ì´í›„ `user-status-update` (ì „ì²´ ìœ ì € ìƒíƒœ ê°±ì‹ )

### ìµœê³  ì…ì°°ì ë˜ëŒë¦¬ê¸°
- ìš”ì²­: `revert-bidder(auctionId, prodKey, winnerId, finalPrice)`
- ì‚¬ìš© ë³€ìˆ˜:
  - DB `product.final_price`, `winner_id` ì—…ë°ì´íŠ¸
  - `auctionStates[auctionId].selectedProduct` ì—…ë°ì´íŠ¸
  - DBì—ì„œ ë‚™ì°°ì ë‹‰ë„¤ì„ ì¡°íšŒ
- ë¸Œë¡œë“œìºìŠ¤íŠ¸:
  - í•´ë‹¹ ë°©ì— `bid-update` (ì—…ë°ì´íŠ¸ëœ ìƒí’ˆÂ·ë‚™ì°°ì ì •ë³´) ì „ì†¡

### ì…ì°° ë‹¨ìœ„ ë³€ê²½
- ìš”ì²­: `change-bid-unit(roomId, newUnit)`
- ì‚¬ìš© ë³€ìˆ˜:
  - `auctionStates[roomId].selectedProduct.unitValue = newUnit`
- ë¸Œë¡œë“œìºìŠ¤íŠ¸: `bid-unit-changed`

### ê²½ë§¤ ì¢…ë£Œ
- ìš”ì²­: `auction-end(auctionId)`
- ì‚¬ìš© ë³€ìˆ˜:
  - DB `auction` í…Œì´ë¸” status='ì¢…ë£Œ', end_time=NOW()ë¡œ ì—…ë°ì´íŠ¸
- ë¸Œë¡œë“œìºìŠ¤íŠ¸: `auction-ended`


## 6. ê¸°íƒ€

### ì‹œì²­ì ìˆ˜ ì¡°íšŒ
- ìš”ì²­: `get-guest-counts(auctionIds[])`
- ì‚¬ìš© ë³€ìˆ˜:
  - `io.sockets.adapter.rooms` (ê° ê²½ë§¤ë°©(room) ì¸ì› ìˆ˜ ì¡°íšŒ)
- ì‘ë‹µ:
  - ì½œë°± í•¨ìˆ˜ë¡œ `{ auctionId: ì¸ì›ìˆ˜ }` ê°ì²´ ë°˜í™˜

</details>